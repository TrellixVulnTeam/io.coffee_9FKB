getDir = ->
  x = Math.floor(Math.random() * Math.pow(16, 4)).toString(16)
  y = Math.floor(Math.random() * Math.pow(16, 4)).toString(16)
  z = Math.floor(Math.random() * Math.pow(16, 4)).toString(16)
  dir = "/tmp/chmodr/" + [
    x
    y
    z
  ].join("/")
  dirs.push dir
  dir
runTest = ->
  test "should complete successfully", (t) ->
    console.error "calling chmodr 0700"
    chmodr.sync "/tmp/chmodr", 0700
    t.end()
    return

  dirs.forEach (dir) ->
    test "verify " + dir, (t) ->
      fs.stat dir, (er, st) ->
        if er
          t.ifError er
          return t.end()
        t.equal st.mode & 0777, 0700, "uid should be 0700"
        t.end()
        return

      return

    return

  test "cleanup", (t) ->
    rimraf "/tmp/chmodr", (er) ->
      t.ifError er
      t.end()
      return

    return

  return
chmodr = require("../")
test = require("tap").test
mkdirp = require("mkdirp")
rimraf = require("rimraf")
fs = require("fs")
dirs = []
rimraf "/tmp/chmodr", (er) ->
  then = (er) ->
    throw er  if er
    runTest()  if --cnt is 0
    return
  throw er  if er
  cnt = 5
  i = 0

  while i < 5
    mkdirp getDir(), then_
    i++
  return

