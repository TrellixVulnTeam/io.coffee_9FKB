common = require("../common")
assert = common.assert
DelayedStream = common.DelayedStream
http = require("http")
UPLOAD = new Buffer(10 * 1024 * 1024)
server = http.createServer((req, res) ->
  delayed = DelayedStream.create(req,
    maxDataSize: UPLOAD.length
  )
  setTimeout (->
    res.writeHead 200
    delayed.pipe res
    return
  ), 10
  return
)
server.listen common.PORT, ->
  request = http.request(
    method: "POST"
    port: common.PORT
  )
  request.write UPLOAD
  request.end()
  request.on "response", (res) ->
    received = 0
    res.on("data", (chunk) ->
      received += chunk.length
      return
    ).on "end", ->
      assert.equal received, UPLOAD.length
      server.close()
      return

    return

  return

