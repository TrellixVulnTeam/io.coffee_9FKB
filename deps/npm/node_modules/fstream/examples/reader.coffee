fstream = require("../fstream.js")
tap = require("tap")
fs = require("fs")
path = require("path")
children = -1
dir = path.dirname(__dirname)
gotReady = false
ended = false
tap.test "reader test", (t) ->
  r = fstream.Reader(
    path: dir
    filter: ->
      
      # return this.parent === r
      @parent is r or this is r
  )
  r.on "ready", ->
    gotReady = true
    children = fs.readdirSync(dir).length
    console.error "Setting expected children to " + children
    t.equal r.type, "Directory", "should be a directory"
    return

  r.on "entry", (entry) ->
    children--
    t.fail "children before ready!"  unless gotReady
    t.equal entry.dirname, r.path, "basename is parent dir"
    return

  r.on "error", (er) ->
    t.fail er
    t.end()
    process.exit 1
    return

  r.on "end", ->
    t.equal children, 0, "should have seen all children"
    ended = true
    return

  closed = false
  r.on "close", ->
    t.ok ended, "saw end before close"
    t.notOk closed, "close should only happen once"
    closed = true
    t.end()
    return

  return

