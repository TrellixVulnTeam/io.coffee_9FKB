"use strict"
fs = require("graceful-fs")
chain = require("slide").chain
crypto = require("crypto")
md5hex = ->
  hash = crypto.createHash("md5")
  ii = 0

  while ii < arguments.length
    hash.update "" + arguments[ii]
    ++ii
  hash.digest "hex"

invocations = 0
getTmpname = (filename) ->
  filename + "." + md5hex(__filename, process.pid, ++invocations)

module.exports = writeFile = (filename, data, options, callback) ->
  if options instanceof Function
    callback = options
    options = null
  options = {}  unless options
  tmpfile = getTmpname(filename)
  chain [
    [
      fs
      fs.writeFile
      tmpfile
      data
      options
    ]
    options.chown and [
      fs
      fs.chown
      tmpfile
      options.chown.uid
      options.chown.gid
    ]
    [
      fs
      fs.rename
      tmpfile
      filename
    ]
  ], (err) ->
    (if err then fs.unlink(tmpfile, ->
      callback err
      return
    ) else callback())
    return

  return

module.exports.sync = writeFileSync = (filename, data, options) ->
  options = {}  unless options
  tmpfile = getTmpname(filename)
  try
    fs.writeFileSync tmpfile, data, options
    fs.chownSync tmpfile, options.chown.uid, options.chown.gid  if options.chown
    fs.renameSync tmpfile, filename
  catch err
    try
      fs.unlinkSync tmpfile
    throw err
  return
