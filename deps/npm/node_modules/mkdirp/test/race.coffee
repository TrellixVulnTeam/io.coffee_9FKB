mkdirp = require("../").mkdirp
path = require("path")
fs = require("fs")
exists = fs.exists or path.exists
test = require("tap").test
test "race", (t) ->
  mk = (file, cb) ->
    mkdirp file, 0755, (err) ->
      t.ifError err
      exists file, (ex) ->
        t.ok ex, "file created"
        fs.stat file, (err, stat) ->
          t.ifError err
          t.equal stat.mode & 0777, 0755
          t.ok stat.isDirectory(), "target not a directory"
          cb()  if cb
          return

        return

      return

    return
  t.plan 6
  ps = [
    ""
    "tmp"
  ]
  i = 0

  while i < 25
    dir = Math.floor(Math.random() * Math.pow(16, 4)).toString(16)
    ps.push dir
    i++
  file = ps.join("/")
  res = 2
  mk file, ->
    t.end()  if --res is 0
    return

  mk file, ->
    t.end()  if --res is 0
    return

  return

