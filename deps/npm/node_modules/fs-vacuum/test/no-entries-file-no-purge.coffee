
# CONSTANTS
log = ->
  messages.push Array::slice.call(arguments).join(" ")
  return
path = require("path")
test = require("tap").test
statSync = require("graceful-fs").statSync
writeFile = require("graceful-fs").writeFile
readdirSync = require("graceful-fs").readdirSync
mkdtemp = require("tmp").dir
mkdirp = require("mkdirp")
vacuum = require("../vacuum.js")
TEMP_OPTIONS =
  unsafeCleanup: true
  mode: "0700"

SHORT_PATH = path.join("i", "am", "a", "path")
PARTIAL_PATH = path.join(SHORT_PATH, "that", "ends", "at", "a")
FULL_PATH = path.join(PARTIAL_PATH, "file")
messages = []
testBase = undefined
partialPath = undefined
fullPath = undefined
test "xXx setup xXx", (t) ->
  mkdtemp TEMP_OPTIONS, (er, tmpdir) ->
    t.ifError er, "temp directory exists"
    testBase = path.resolve(tmpdir, SHORT_PATH)
    partialPath = path.resolve(tmpdir, PARTIAL_PATH)
    fullPath = path.resolve(tmpdir, FULL_PATH)
    mkdirp partialPath, (er) ->
      t.ifError er, "made test path"
      writeFile fullPath, new Buffer("hi"), (er) ->
        t.ifError er, "made file"
        t.end()
        return

      return

    return

  return

test "remove up to a point", (t) ->
  vacuum fullPath,
    purge: false
    base: testBase
    log: log
  , (er) ->
    verify = ->
      stat = statSync(verifyPath)
      return
    t.ifError er, "cleaned up to base"
    t.equal messages.length, 6, "got 5 removal & 1 finish message"
    t.equal messages[5], "finished vacuuming up to " + testBase
    stat = undefined
    verifyPath = fullPath
    
    # handle the file separately
    t.throws verify, verifyPath + " cannot be statted"
    t.notOk stat and stat.isFile(), verifyPath + " is totally gone"
    verifyPath = path.dirname(verifyPath)
    i = 0

    while i < 4
      t.throws verify, verifyPath + " cannot be statted"
      t.notOk stat and stat.isDirectory(), verifyPath + " is totally gone"
      verifyPath = path.dirname(verifyPath)
      i++
    t.doesNotThrow (->
      stat = statSync(testBase)
      return
    ), testBase + " can be statted"
    t.ok stat and stat.isDirectory(), testBase + " is still a directory"
    files = readdirSync(testBase)
    t.equal files.length, 0, "nothing left in base directory"
    t.end()
    return

  return

