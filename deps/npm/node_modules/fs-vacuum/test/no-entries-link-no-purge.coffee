
# CONSTANTS
log = ->
  messages.push Array::slice.call(arguments).join(" ")
  return
path = require("path")
test = require("tap").test
statSync = require("graceful-fs").statSync
symlinkSync = require("graceful-fs").symlinkSync
readdirSync = require("graceful-fs").readdirSync
mkdtemp = require("tmp").dir
mkdirp = require("mkdirp")
vacuum = require("../vacuum.js")
TEMP_OPTIONS =
  unsafeCleanup: true
  mode: "0700"

SHORT_PATH = path.join("i", "am", "a", "path")
TARGET_PATH = path.join("target-link", "in", "the", "middle")
PARTIAL_PATH = path.join(SHORT_PATH, "with", "a")
FULL_PATH = path.join(PARTIAL_PATH, "link")
EXPANDO_PATH = path.join(SHORT_PATH, "with", "a", "link", "in", "the", "middle")
messages = []
testBase = undefined
targetPath = undefined
partialPath = undefined
fullPath = undefined
expandoPath = undefined
test "xXx setup xXx", (t) ->
  mkdtemp TEMP_OPTIONS, (er, tmpdir) ->
    t.ifError er, "temp directory exists"
    testBase = path.resolve(tmpdir, SHORT_PATH)
    targetPath = path.resolve(tmpdir, TARGET_PATH)
    partialPath = path.resolve(tmpdir, PARTIAL_PATH)
    fullPath = path.resolve(tmpdir, FULL_PATH)
    expandoPath = path.resolve(tmpdir, EXPANDO_PATH)
    mkdirp partialPath, (er) ->
      t.ifError er, "made test path"
      mkdirp targetPath, (er) ->
        t.ifError er, "made target path"
        symlinkSync path.join(tmpdir, "target-link"), fullPath
        t.end()
        return

      return

    return

  return

test "remove up to a point", (t) ->
  vacuum expandoPath,
    purge: false
    base: testBase
    log: log
  , (er) ->
    verify = ->
      stat = statSync(verifyPath)
      return
    t.ifError er, "cleaned up to base"
    t.equal messages.length, 7, "got 6 removal & 1 finish message"
    t.equal messages[6], "finished vacuuming up to " + testBase
    stat = undefined
    verifyPath = expandoPath
    i = 0

    while i < 6
      t.throws verify, verifyPath + " cannot be statted"
      t.notOk stat and stat.isDirectory(), verifyPath + " is totally gone"
      verifyPath = path.dirname(verifyPath)
      i++
    t.doesNotThrow (->
      stat = statSync(testBase)
      return
    ), testBase + " can be statted"
    t.ok stat and stat.isDirectory(), testBase + " is still a directory"
    files = readdirSync(testBase)
    t.equal files.length, 0, "nothing left in base directory"
    t.end()
    return

  return

