
# CONSTANTS
log = ->
  messages.push Array::slice.call(arguments).join(" ")
  return
path = require("path")
test = require("tap").test
statSync = require("graceful-fs").statSync
writeFileSync = require("graceful-fs").writeFileSync
mkdtemp = require("tmp").dir
mkdirp = require("mkdirp")
vacuum = require("../vacuum.js")
TEMP_OPTIONS =
  unsafeCleanup: true
  mode: "0700"

SHORT_PATH = path.join("i", "am", "a", "path")
LONG_PATH = path.join(SHORT_PATH, "of", "a", "certain", "kind")
FIRST_FILE = path.join(LONG_PATH, "monsieurs")
SECOND_FILE = path.join(LONG_PATH, "mesdames")
messages = []
testPath = undefined
testBase = undefined
test "xXx setup xXx", (t) ->
  mkdtemp TEMP_OPTIONS, (er, tmpdir) ->
    t.ifError er, "temp directory exists"
    testBase = path.resolve(tmpdir, SHORT_PATH)
    testPath = path.resolve(tmpdir, LONG_PATH)
    mkdirp testPath, (er) ->
      t.ifError er, "made test path"
      writeFileSync path.resolve(tmpdir, FIRST_FILE), new Buffer("c'est vraiment joli")
      writeFileSync path.resolve(tmpdir, SECOND_FILE), new Buffer("oui oui")
      t.end()
      return

    return

  return

test "remove up to a point", (t) ->
  vacuum testPath,
    purge: true
    base: testBase
    log: log
  , (er) ->
    verify = ->
      stat = statSync(verifyPath)
      return
    t.ifError er, "cleaned up to base"
    t.equal messages.length, 5, "got 4 removal & 1 finish message"
    t.equal messages[0], "purging " + testPath
    t.equal messages[4], "finished vacuuming up to " + testBase
    stat = undefined
    verifyPath = testPath
    i = 0

    while i < 4
      t.throws verify, verifyPath + " cannot be statted"
      t.notOk stat and stat.isDirectory(), verifyPath + " is totally gone"
      verifyPath = path.dirname(verifyPath)
      i++
    t.doesNotThrow (->
      stat = statSync(testBase)
      return
    ), testBase + " can be statted"
    t.ok stat and stat.isDirectory(), testBase + " is still a directory"
    t.end()
    return

  return

