tap = require("tap")
normalize = require("../lib/normalize")
path = require("path")
fs = require("fs")
_ = require("underscore")
async = require("async")
data = undefined
clonedData = undefined
warn = undefined
tap.test "consistent normalization", (t) ->
  path.resolve __dirname, "./fixtures/read-package-json.json"
  fs.readdir __dirname + "/fixtures", (err, entries) ->
    
    # entries = ['coffee-script.json'] // uncomment to limit to a specific file
    verifyConsistency = (entryName, next) ->
      warn = (msg) ->

      
      # t.equal("",msg) // uncomment to have some kind of logging of warnings
      filename = __dirname + "/fixtures/" + entryName
      fs.readFile filename, (err, contents) ->
        return next(err)  if err
        data = JSON.parse(contents.toString())
        normalize data, warn
        clonedData = _.clone(data)
        normalize data, warn
        t.deepEqual clonedData, data, "Normalization of " + entryName + " is consistent."
        next null
        return

      return

    # fs.readFile
    # verifyConsistency
    async.forEach entries, verifyConsistency, (err) ->
      throw err  if err
      t.end()
      return

    return

  return

# fs.readdir
# tap.test
