chain = (things, cb) ->
  res = []
  (LOOP = (i, len) ->
    return cb(null, res)  if i >= len
    if Array.isArray(things[i])
      things[i] = bindActor.apply(null, things[i].map((i) ->
        (if (i is chain.first) then res[0] else (if (i is chain.last) then res[res.length - 1] else i))
      ))
    return LOOP(i + 1, len)  unless things[i]
    things[i] (er, data) ->
      return cb(er, res)  if er
      res = res.concat(data)  if data isnt `undefined`
      LOOP i + 1, len
      return

    return
  ) 0, things.length
  return
module.exports = chain
bindActor = require("./bind-actor.js")
chain.first = {}
chain.last = {}
