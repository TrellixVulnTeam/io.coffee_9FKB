test = require("tap").test
dz = require("../dezalgo.js")
test "the dark pony", (t) ->
  foo = (i, cb) ->
    cb = dz(cb)
    if ++n % 2
      cb true, i
    else
      process.nextTick cb.bind(null, false, i)
    return
  n = 0
  called = 0
  order = [
    0
    2
    4
    6
    8
    1
    3
    5
    7
    9
  ]
  o = 0
  i = 0

  while i < 10
    foo i, (cached, i) ->
      t.equal i, order[o++]
      t.equal i % 2, (if cached then 0 else 1)
      called++
      return

    t.equal called, 0
    i++
  setTimeout ->
    t.equal called, 10
    t.end()
    return

  return

