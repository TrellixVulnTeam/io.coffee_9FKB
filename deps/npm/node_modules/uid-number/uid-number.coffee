
# This module calls into get-uid-gid.js, which sets the
# uid and gid to the supplied argument, in order to find out their
# numeric value.  This can't be done in the main node process,
# because otherwise node would be running as that user from this
# point on.
uidNumber = (uid, gid, cb) ->
  return cb()  unless uidSupport
  if typeof cb isnt "function"
    cb = gid
    gid = null
  if typeof cb isnt "function"
    cb = uid
    uid = null
  gid = process.getgid()  unless gid?
  uid = process.getuid()  unless uid?
  gid = gidCache[gid] = +gid  unless isNaN(gid)
  uid = uidCache[uid] = +uid  unless isNaN(uid)
  uid = uidCache[uid]  if uidCache.hasOwnProperty(uid)
  gid = gidCache[gid]  if gidCache.hasOwnProperty(gid)
  return process.nextTick(cb.bind(null, null, uid, gid))  if typeof gid is "number" and typeof uid is "number"
  getter = require.resolve("./get-uid-gid.js")
  child_process.execFile process.execPath, [
    getter
    uid
    gid
  ], (code, out, err) ->
    return cb(new Error("could not get uid/gid\n" + err))  if er
    try
      out = JSON.parse(out + "")
    catch ex
      return cb(ex)
    if out.error
      er = new Error(out.error)
      er.errno = out.errno
      return cb(er)
    return cb(new Error("Could not get uid/gid: " + JSON.stringify(out)))  if isNaN(out.uid) or isNaN(out.gid)
    cb null, uidCache[uid] = +out.uid, gidCache[gid] = +out.gid
    return

  return
module.exports = uidNumber
child_process = require("child_process")
path = require("path")
uidSupport = process.getuid and process.setuid
uidCache = {}
gidCache = {}
