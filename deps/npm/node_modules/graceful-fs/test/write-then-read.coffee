fs = require("../")
rimraf = require("rimraf")
mkdirp = require("mkdirp")
test = require("tap").test
p = require("path").resolve(__dirname, "files")

# Make sure to reserve the stderr fd
process.stderr.write ""
num = 4097
paths = new Array(num)
test "make files", (t) ->
  rimraf.sync p
  mkdirp.sync p
  i = 0

  while i < num
    paths[i] = "files/file-" + i
    fs.writeFileSync paths[i], "content"
    ++i
  t.end()
  return

test "read files", (t) ->
  
  # now read them
  done = 0
  i = 0

  while i < num
    fs.readFile paths[i], (err, data) ->
      throw err  if err
      ++done
      if done is num
        t.pass "success"
        t.end()
      return

    ++i
  return

test "cleanup", (t) ->
  rimraf.sync p
  t.end()
  return

