tap = require("tap")
crypto = require("crypto")
fs = require("fs")
server = require("./lib/server.js")
common = require("./lib/common.js")
nerfed = "//localhost:" + server.port + "/:"
configuration = {}
configuration[nerfed + "username"] = "username"
configuration[nerfed + "_password"] = new Buffer("%1234@asdf%").toString("base64")
configuration[nerfed + "email"] = "i@izs.me"
client = common.freshClient(configuration)
tap.test "publish", (t) ->
  
  # not really a tarball, but doesn't matter
  tarball = require.resolve("../package.json")
  pd = fs.readFileSync(tarball, "base64")
  pkg = require("../package.json")
  server.expect "/npm-registry-client", (req, res) ->
    t.equal req.method, "PUT"
    b = ""
    req.setEncoding "utf8"
    req.on "data", (d) ->
      b += d
      return

    req.on "end", ->
      o = JSON.parse(b)
      t.equal o._id, "npm-registry-client"
      t.equal o["dist-tags"].latest, pkg.version
      t.has o.versions[pkg.version], pkg
      t.same o.maintainers, [
        name: "username"
        email: "i@izs.me"
      ]
      t.same o.maintainers, o.versions[pkg.version].maintainers
      att = o._attachments[pkg.name + "-" + pkg.version + ".tgz"]
      t.same att.data, pd
      hash = crypto.createHash("sha1").update(pd, "base64").digest("hex")
      t.equal o.versions[pkg.version].dist.shasum, hash
      res.statusCode = 201
      res.json created: true
      return

    return

  client.publish "http://localhost:1337/", pkg, tarball, (er, data) ->
    throw er  if er
    t.deepEqual data,
      created: true

    t.end()
    return

  return

