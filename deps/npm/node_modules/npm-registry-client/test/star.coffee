tap = require("tap")
server = require("./lib/server.js")
common = require("./lib/common.js")
DEP_USER = "username"
nerfed = "//localhost:" + server.port + "/:"
configuration = {}
configuration[nerfed + "username"] = DEP_USER
configuration[nerfed + "_password"] = new Buffer("%1234@asdf%").toString("base64")
configuration[nerfed + "email"] = "i@izs.me"
client = common.freshClient(configuration)
cache = require("./fixtures/underscore/cache.json")
tap.test "star a package", (t) ->
  server.expect "GET", "/underscore?write=true", (req, res) ->
    t.equal req.method, "GET"
    res.json cache
    return

  server.expect "PUT", "/underscore", (req, res) ->
    t.equal req.method, "PUT"
    b = ""
    req.setEncoding "utf8"
    req.on "data", (d) ->
      b += d
      return

    req.on "end", ->
      updated = JSON.parse(b)
      already = [
        "vesln"
        "mvolkmann"
        "lancehunt"
        "mikl"
        "linus"
        "vasc"
        "bat"
        "dmalam"
        "mbrevoort"
        "danielr"
        "rsimoes"
        "thlorenz"
      ]
      i = 0

      while i < already.length
        current = already[i]
        t.ok updated.users[current], current + " still likes this package"
        i++
      t.ok updated.users[DEP_USER], "user is in the starred list"
      res.statusCode = 201
      res.json starred: true
      return

    return

  client.star "http://localhost:1337/underscore", true, (error, data) ->
    t.ifError error, "no errors"
    t.ok data.starred, "was starred"
    t.end()
    return

  return

