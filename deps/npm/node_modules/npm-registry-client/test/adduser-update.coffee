tap = require("tap")
server = require("./lib/server.js")
common = require("./lib/common.js")
client = common.freshClient()
password = "%1234@asdf%"
username = "username"
email = "i@izs.me"
userdata =
  name: username
  email: email
  _id: "org.couchdb.user:username"
  type: "user"
  roles: []
  date: "2012-06-07T04:11:21.591Z"

SD = require("string_decoder").StringDecoder
decoder = new SD()
tap.test "update a user acct", (t) ->
  server.expect "PUT", "/-/user/org.couchdb.user:username", (req, res) ->
    t.equal req.method, "PUT"
    res.statusCode = 409
    res.json error: "conflict"
    return

  server.expect "GET", "/-/user/org.couchdb.user:username?write=true", (req, res) ->
    t.equal req.method, "GET"
    res.json userdata
    return

  server.expect "PUT", "/-/user/org.couchdb.user:username/-rev/" + userdata._rev, (req, res) ->
    t.equal req.method, "PUT"
    b = ""
    req.on "data", (d) ->
      b += decoder.write(d)
      return

    req.on "end", ->
      o = JSON.parse(b)
      userdata.password = password
      userdata.date = o.date
      t.deepEqual o, userdata
      res.statusCode = 201
      res.json created: true
      return

    return

  client.adduser "http://localhost:1337/", username, password, email, (er, data) ->
    throw er  if er
    t.deepEqual data,
      created: true

    t.end()
    return

  return

