tap = require("tap")
server = require("./lib/server.js")
common = require("./lib/common.js")
nerfed = "//localhost:" + server.port + "/:"
configuration = {}
configuration[nerfed + "username"] = "username"
configuration[nerfed + "_password"] = new Buffer("%1234@asdf%").toString("base64")
configuration[nerfed + "email"] = "i@izs.me"
client = common.freshClient(configuration)
tap.test "tag a package", (t) ->
  server.expect "PUT", "/underscore/not-lodash", (req, res) ->
    t.equal req.method, "PUT"
    b = ""
    req.setEncoding "utf8"
    req.on "data", (d) ->
      b += d
      return

    req.on "end", ->
      updated = JSON.parse(b)
      t.deepEqual updated,
        "1.3.2": {}

      res.statusCode = 201
      res.json tagged: true
      return

    return

  client.tag "http://localhost:1337/underscore",
    "1.3.2": {}
  , "not-lodash", (error, data) ->
    t.ifError error, "no errors"
    t.ok data.tagged, "was tagged"
    t.end()
    return

  return

