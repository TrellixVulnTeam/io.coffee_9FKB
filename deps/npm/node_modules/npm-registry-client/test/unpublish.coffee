tap = require("tap")
server = require("./lib/server.js")
common = require("./lib/common.js")
nerfed = "//localhost:" + server.port + "/:"
configuration = {}
configuration[nerfed + "_authToken"] = "of-glad-tidings"
client = common.freshClient(configuration)
cache = require("./fixtures/underscore/cache.json")
REV = "/-rev/72-47f2986bfd8e8b55068b204588bbf484"
VERSION = "1.3.2"
tap.test "unpublish a package", (t) ->
  server.expect "GET", "/underscore?write=true", (req, res) ->
    t.equal req.method, "GET"
    res.json cache
    return

  server.expect "PUT", "/underscore" + REV, (req, res) ->
    t.equal req.method, "PUT"
    b = ""
    req.setEncoding "utf-8"
    req.on "data", (d) ->
      b += d
      return

    req.on "end", ->
      updated = JSON.parse(b)
      t.notOk updated.versions[VERSION]
      return

    res.json cache
    return

  server.expect "GET", "/underscore", (req, res) ->
    t.equal req.method, "GET"
    res.json cache
    return

  server.expect "DELETE", "/underscore/-/underscore-1.3.2.tgz" + REV, (req, res) ->
    t.equal req.method, "DELETE"
    res.json unpublished: true
    return

  client.unpublish "http://localhost:1337/underscore", VERSION, (error) ->
    t.ifError error, "no errors"
    t.end()
    return

  return

