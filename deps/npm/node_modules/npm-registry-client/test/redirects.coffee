tap = require("tap")
server = require("./lib/server.js")
common = require("./lib/common.js")
client = common.freshClient()
pkg =
  _id: "some-package@1.2.3"
  name: "some-package"
  version: "1.2.3"

tap.test "basic request", (t) ->
  
  # Expect one request for { follow : false }
  server.expect "/-/some-package/1.2.3", (req, res) ->
    res.writeHead 301,
      Location: "/some-package/1.2.3"

    res.end "Redirecting"
    return

  
  # Expect 2 requests for { follow : true }
  server.expect "/-/some-package/1.2.3", (req, res) ->
    res.writeHead 301,
      Location: "/some-package/1.2.3"

    res.end "Redirecting"
    return

  server.expect "/some-package/1.2.3", (req, res) ->
    res.json pkg
    return

  t.plan 2
  client.get "http://localhost:1337/-/some-package/1.2.3",
    follow: false
  , (er, data) ->
    t.assert er, "Error must be set"
    return

  client.get "http://localhost:1337/-/some-package/1.2.3",
    follow: true
  , (er, data) ->
    t.deepEqual data, pkg
    return

  return

