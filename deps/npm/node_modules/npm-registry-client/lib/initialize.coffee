initialize = (uri, method, accept, headers) ->
  unless @sessionToken
    @sessionToken = crypto.randomBytes(8).toString("hex")
    @log.verbose "request id", @sessionToken
  strict = @conf.get("strict-ssl")
  strict = true  if strict is `undefined`
  p = @conf.get("proxy")
  sp = @conf.get("https-proxy") or p
  opts =
    url: uri
    method: method
    headers: headers
    proxy: (if uri.protocol is "https:" then sp else p)
    localAddress: @conf.get("local-address")
    strictSSL: strict
    cert: @conf.get("cert")
    key: @conf.get("key")
    ca: @conf.get("ca")

  headers.version = @version or pkg.version
  headers.accept = accept
  headers.referer = @refer  if @refer
  headers["npm-session"] = @sessionToken
  headers["user-agent"] = @conf.get("user-agent") or "node/" + process.version
  opts
crypto = require("crypto")
pkg = require("../package.json")
module.exports = initialize
