authify = (authed, parsed, headers) ->
  c = @conf.getCredentialsByURI(url.format(parsed))
  if c and c.token
    @log.verbose "request", "using bearer token for auth"
    headers.authorization = "Bearer " + c.token
    return null
  if authed
    if c and c.username and c.password
      username = encodeURIComponent(c.username)
      password = encodeURIComponent(c.password)
      parsed.auth = username + ":" + password
    else
      new Error("This request requires auth credentials. Run `npm login` and repeat the request.")
  return
url = require("url")
module.exports = authify
