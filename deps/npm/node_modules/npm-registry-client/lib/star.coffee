star = (uri, starred, cb) ->
  c = @conf.getCredentialsByURI(uri)
  if c.token
    return cb(new Error("This operation is unsupported for token-based auth"))
  else return cb(new Error("Must be logged in to star/unstar packages"))  unless c.auth
  @request "GET", uri + "?write=true", null, ((er, fullData) ->
    return cb(er)  if er
    fullData =
      _id: fullData._id
      _rev: fullData._rev
      users: fullData.users or {}

    if starred
      @log.info "starring", fullData._id
      fullData.users[c.username] = true
      @log.verbose "starring", fullData
    else
      delete fullData.users[c.username]

      @log.info "unstarring", fullData._id
      @log.verbose "unstarring", fullData
    @request "PUT", uri,
      body: fullData
    , cb
  ).bind(this)
  return
module.exports = star
